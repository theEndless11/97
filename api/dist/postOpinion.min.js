"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=handler;var _db=require("../utils/db"),_mongoose=_interopRequireDefault(require("mongoose")),_ably=require("../utils/ably");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var postSchema=new _mongoose.default.Schema({message:String,timestamp:Date,username:String,sessionId:String,likes:{type:Number,default:0},dislikes:{type:Number,default:0},likedBy:[String],dislikedBy:[String],comments:[{username:String,comment:String,timestamp:Date}]}),Post=_mongoose.default.model("Post",postSchema);function handler(s,t){var r,a,n,o,i,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if("POST"!==s.method){e.next=34;break}if(r=s.body,a=r.message,n=r.username,o=r.sessionId,a&&""!==a.trim()){e.next=4;break}return e.abrupt("return",t.status(400).json({message:"Message cannot be empty"}));case 4:if(n&&o){e.next=6;break}return e.abrupt("return",t.status(400).json({message:"Username and sessionId are required"}));case 6:return e.prev=6,console.log("Connecting to database..."),e.next=10,regeneratorRuntime.awrap((0,_db.connectToDatabase)());case 10:return console.log("Database connected successfully."),i=new Post({message:a,timestamp:new Date,username:n,sessionId:o}),e.next=14,regeneratorRuntime.awrap(i.save());case 14:return console.log("New post saved:",i),e.prev=15,e.next=18,regeneratorRuntime.awrap((0,_ably.publishToAbly)("newOpinion",i));case 18:console.log("Post published to Ably:",i),e.next=24;break;case 21:e.prev=21,e.t0=e.catch(15),console.error("Error publishing to Ably:",e.t0);case 24:u={_id:i._id,message:i.message,timestamp:i.timestamp,username:i.username,likes:i.likes,dislikes:i.dislikes,comments:i.comments},t.status(201).json(u),e.next=32;break;case 28:e.prev=28,e.t1=e.catch(6),console.error("Error saving post:",e.t1),t.status(500).json({message:"Error saving post",error:e.t1});case 32:e.next=35;break;case 34:t.status(405).json({message:"Method Not Allowed"});case 35:case"end":return e.stop()}},null,null,[[6,28],[15,21]])}
//# sourceMappingURL=postOpinion.min.js.map
